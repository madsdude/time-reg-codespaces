
<!doctype html>
<html lang="da">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tidregistrering v2.3</title>
<style>
  :root { --fg:#111; --muted:#666; --bd:#e8e8e8; --card:#fff; --shadow:0 2px 10px rgba(0,0,0,.06); }
  * { box-sizing: border-box; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; color:var(--fg); background:#f6f7f9; }
  main { max-width: 1040px; margin: 2rem auto; padding: 0 1rem; }
  h1 { display:flex; gap:.6rem; align-items:center; font-size: 2rem; margin: 0 0 .75rem; }
  h2 { margin: 0 0 .75rem; }
  .muted { color: var(--muted); }
  .card { background:var(--card); border:1px solid var(--bd); border-radius: 14px; padding: 1.25rem; box-shadow: var(--shadow); margin: 1.25rem 0; }

  input, select, button, textarea { font-size: 1rem; padding: .7rem .9rem; border-radius: 10px; border: 1px solid #d0d0d0; background:#fff; }
  input, select, textarea { width: 100%; }
  button { cursor: pointer; white-space: nowrap; }
  button:disabled { opacity:.55; cursor:not-allowed; }

  .row { display: grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap: 1rem; align-items: start; }
  .row > * { min-width: 0; }
  label { font-size: .9rem; color: #444; display: block; margin-bottom: .35rem; }
  .note { grid-column: 1 / -1; }
  @media (max-width: 820px) { .row { grid-template-columns: repeat(2, minmax(0,1fr)); } }

  table { width: 100%; border-collapse: collapse; background:#fff; }
  th, td { padding: .7rem .6rem; border-bottom: 1px solid #eee; text-align: left; }
  tfoot td { font-weight: 600; }
  .right { text-align: right; }

  .tabs { display:flex; gap:.5rem; flex-wrap: wrap; align-items:center; margin-bottom:.75rem; }
  .tabs button { padding:.45rem .8rem; border-radius:8px; border:1px solid #ccc; background:#fff; }
  .tabs button.active { background:#111; color:#fff; border-color:#111; }
  .filters { display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; margin-left:auto; }
  .filters label { margin: 0 .15rem 0 0; }
  .hidden { display:none; }
  .btn-link { background:transparent; border:none; padding:.2rem .4rem; color:#c00; cursor:pointer; }
  .btn-link:hover { text-decoration: underline; }
</style>
</head>
<body>
<main>
  <h1>ðŸ•’ Tidregistrering</h1>
  <p class="muted">Ingen pause â€“ varighed = hele intervallet. VÃ¦lg person, registrÃ©r tid, og brug fanerne nedenfor.</p>

  <section class="card" id="formCard">
    <h2>Ny registrering</h2>
    <div class="row">
      <div>
        <label for="work_date">Dato</label>
        <input id="work_date" type="date" placeholder="yyyy-mm-dd">
      </div>
      <div>
        <label for="user">Person</label>
        <select id="user"></select>
      </div>
      <div>
        <label for="start_time">Start</label>
        <input id="start_time" type="time" value="08:00">
      </div>
      <div>
        <label for="end_time">Slut</label>
        <input id="end_time" type="time" value="16:00">
      </div>
      <div class="note">
        <label for="note">Note</label>
        <textarea id="note" rows="2" placeholder="Valgfri note..."></textarea>
      </div>
    </div>
    <div class="muted" style="margin-top:.4rem;">Tip: Nattevagt? Start <b>22:00</b>, Slut <b>06:00</b> â€“ systemet tÃ¦ller over midnat.</div>
    <div style="margin-top: .9rem; display:flex; gap:.6rem; align-items:center;">
      <button id="saveBtn" type="button">Gem registrering</button>
      <span id="msg" class="muted"></span>
    </div>
  </section>

  <section class="card">
    <div class="tabs">
      <div style="display:flex; gap:.5rem;">
        <button id="tabOverview" class="active" type="button">Oversigt</button>
        <button id="tabSummary"  type="button">Opsummering</button>
      </div>
      <div class="filters">
        <label for="from">Fra</label>
        <input id="from" type="date" placeholder="yyyy-mm-dd" style="min-width:160px;">
        <label for="to">Til</label>
        <input id="to" type="date" placeholder="yyyy-mm-dd" style="min-width:160px;">
        <button id="filterBtn" type="button">Hent</button>

        <button id="csvBtn"  type="button" title="Download CSV (detaljer)">CSV</button>
        <button id="xlsxBtn" type="button" title="Download Excel (detaljer)">Excel</button>
        <button id="xlsxSummaryBtn" type="button" class="hidden" title="Download Excel (opsummering)">Excel (opsum.)</button>

        <span id="totalLabel" class="muted"></span>
      </div>
    </div>

    <!-- Oversigt -->
    <div id="panelOverview">
      <table>
        <thead>
          <tr>
            <th>Dato</th>
            <th>Person</th>
            <th>Start</th>
            <th>Slut</th>
            <th class="right">Timer</th>
            <th>Note</th>
            <th>Slet</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
        <tfoot>
          <tr>
            <td colspan="4" class="right">Total</td>
            <td class="right" id="totalHours">0.0</td>
            <td></td>
            <td></td>
          </tr>
        </tfoot>
      </table>
    </div>

    <!-- Opsummering -->
    <div id="panelSummary" class="hidden">
      <table>
        <thead>
          <tr>
            <th>Person</th>
            <th class="right">Antal registreringer</th>
            <th class="right">Minutter</th>
            <th class="right">Timer</th>
          </tr>
        </thead>
        <tbody id="tbodySummary"></tbody>
      </table>
    </div>
  </section>
</main>

<script>
  // Helpers
  function fmtDateOnly(s){ if(!s) return ''; if(typeof s==='string') return s.slice(0,10); try{ return new Date(s).toISOString().slice(0,10);}catch{ return String(s);} }
  function fmtHours(mins){ return (Number(mins)/60).toFixed(1).replace('.', ','); }
  function toISODate(d){ const date=(d instanceof Date)?d:new Date(d); const z=new Date(date.getTime()-date.getTimezoneOffset()*60000); return z.toISOString().slice(0,10); }
  function mondayOfWeek(d){ const dt=(d instanceof Date)?new Date(d):new Date(String(d)); const day=(dt.getDay()+6)%7; dt.setDate(dt.getDate()-day); return toISODate(dt); }
  function sundayOfWeek(d){ const dt=(d instanceof Date)?new Date(d):new Date(String(d)); const day=(dt.getDay()+6)%7; dt.setDate(dt.getDate()+(6-day)); return toISODate(dt); }
  function getDateValue(id){ const el=document.getElementById(id); if(el&&el.valueAsDate instanceof Date) return toISODate(el.valueAsDate); const v=(el&&el.value)||''; if(/^\d{4}-\d{2}-\d{2}$/.test(v)) return v; const m=v.match(/^(\d{2})-(\d{2})-(\d{4})$/); if(m) return `${m[3]}-${m[2]}-${m[1]}`; return v; }
  function selectedUserId(){ const v=(document.getElementById('user')?.value||'').trim(); return v?Number(v):null; }

  // API
  async function loadUsers(){
    const res = await fetch('/api/users');
    const data = await res.json();
    const sel = document.getElementById('user');
    sel.innerHTML = '';
    if (!Array.isArray(data) || !data.length){
      const opt = document.createElement('option'); opt.value=''; opt.textContent='â€” Ingen personer â€”'; sel.appendChild(opt);
      document.getElementById('saveBtn').disabled = true; return;
    }
    for (const u of data){ const opt=document.createElement('option'); opt.value=String(u.id); opt.textContent=u.name; sel.appendChild(opt); }
    sel.selectedIndex=0; document.getElementById('saveBtn').disabled=false;
  }

  async function loadEntries(){
    const from=getDateValue('from'); const to=getDateValue('to');
    const url=new URL('/api/time-entries', window.location.origin); if(from) url.searchParams.set('from',from); if(to) url.searchParams.set('to',to);
    const res=await fetch(url); const list=await res.json();
    const tbody=document.getElementById('tbody'); tbody.innerHTML=''; let total=0;
    const myUserId = selectedUserId();

    for(const r of list){
      total+=Number(r.duration_minutes||0);
      const canDelete = myUserId && Number(r.user_id) === Number(myUserId);
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${fmtDateOnly(r.work_date)}</td>
        <td>${r.user_name}</td>
        <td>${String(r.start_time).slice(0,5)}</td>
        <td>${String(r.end_time).slice(0,5)}</td>
        <td class="right">${fmtHours(r.duration_minutes)}</td>
        <td>${r.note||''}</td>
        <td>${canDelete?`<button class="btn-link" data-id="${r.id}">Slet</button>`:''}</td>`;
      if (canDelete) tr.querySelector('button[data-id]').addEventListener('click', () => deleteEntry(r.id));
      tbody.appendChild(tr);
    }
    document.getElementById('totalHours').textContent=fmtHours(total);
    document.getElementById('totalLabel').textContent=`Ugens total: ${fmtHours(total)} t`;
  }

  async function loadSummary(){
    const from=getDateValue('from'); const to=getDateValue('to');
    const url=new URL('/api/summary', window.location.origin); if(from) url.searchParams.set('from',from); if(to) url.searchParams.set('to',to);
    const res=await fetch(url); const list=await res.json();
    const tbody=document.getElementById('tbodySummary'); tbody.innerHTML='';
    for(const r of list){
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td>${r.user_name}</td>
        <td class="right">${r.entries}</td>
        <td class="right">${r.minutes}</td>
        <td class="right">${(r.hours).toFixed(2).replace('.', ',')}</td>`;
      tbody.appendChild(tr);
    }
  }

  async function saveEntry(){
    const msg=document.getElementById('msg'); msg.textContent='';
    const sel=document.getElementById('user'); const val=(sel&&sel.value)?sel.value.trim():'';
    if(!val){ msg.textContent='VÃ¦lg en person'; return; }
    const body={
      user_id:Number(val),
      work_date:document.getElementById('work_date').value,
      start_time:document.getElementById('start_time').value,
      end_time:document.getElementById('end_time').value,
      note:document.getElementById('note').value||null
    };
    const res=await fetch('/api/time-entries',{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
    if(res.ok){
      msg.textContent='Gemt!';
      document.getElementById('note').value='';
      const summaryActive=document.getElementById('tabSummary').classList.contains('active');
      if(summaryActive) await loadSummary(); else await loadEntries();
    }else{
      const j=await res.json().catch(()=>({})); msg.textContent=j.error||'Fejl';
    }
  }

  async function deleteEntry(id){
    const uid = selectedUserId();
    if (!uid) { alert('VÃ¦lg fÃ¸rst en person i formularen.'); return; }
    if (!confirm('Slet denne registrering?')) return;
    const res = await fetch(`/api/time-entries/${id}?user_id=${uid}`, { method:'DELETE' });
    if (res.status === 204) { await loadEntries(); }
    else { const j = await res.json().catch(()=>({})); alert(j.error || 'Kunne ikke slette'); }
  }

  function exportList(kind){
    const from=getDateValue('from'); const to=getDateValue('to');
    const url=new URL(`/api/export.${kind}`, window.location.origin);
    if(from) url.searchParams.set('from',from);
    if(to)   url.searchParams.set('to',to);
    window.location.href=url.toString();
  }
  function exportSummaryXlsx(){
    const from=getDateValue('from'); const to=getDateValue('to');
    const url=new URL('/api/export-summary.xlsx', window.location.origin);
    if(from) url.searchParams.set('from',from);
    if(to)   url.searchParams.set('to',to);
    window.location.href=url.toString();
  }
  function setToolbarFor(tab){
    const showSummary = tab==='summary';
    document.getElementById('csvBtn').classList.toggle('hidden', showSummary);
    document.getElementById('xlsxBtn').classList.toggle('hidden', showSummary);
    document.getElementById('xlsxSummaryBtn').classList.toggle('hidden', !showSummary);
  }
  function showTab(which){
    const o=document.getElementById('panelOverview');
    const s=document.getElementById('panelSummary');
    const btnO=document.getElementById('tabOverview');
    const btnS=document.getElementById('tabSummary');
    if(which==='summary'){ o.classList.add('hidden'); s.classList.remove('hidden'); btnO.classList.remove('active'); btnS.classList.add('active'); setToolbarFor('summary'); loadSummary(); }
    else { s.classList.add('hidden'); o.classList.remove('hidden'); btnS.classList.remove('active'); btnO.classList.add('active'); setToolbarFor('overview'); loadEntries(); }
  }

  // Init
  document.addEventListener('DOMContentLoaded', () => {
    const today=new Date();
    document.getElementById('work_date').value=toISODate(today);
    document.getElementById('from').value=mondayOfWeek(today);
    document.getElementById('to').value=sundayOfWeek(today);

    const saveBtn=document.getElementById('saveBtn'); saveBtn.disabled=true;
    document.getElementById('saveBtn').addEventListener('click', saveEntry);
    document.getElementById('filterBtn').addEventListener('click', () => {
      const summaryActive=document.getElementById('tabSummary').classList.contains('active');
      if(summaryActive) loadSummary(); else loadEntries();
    });
    document.getElementById('csvBtn').addEventListener('click', () => exportList('csv'));
    document.getElementById('xlsxBtn').addEventListener('click', () => exportList('xlsx'));
    document.getElementById('xlsxSummaryBtn').addEventListener('click', exportSummaryXlsx);
    document.getElementById('tabOverview').addEventListener('click', () => showTab('overview'));
    document.getElementById('tabSummary').addEventListener('click', () => showTab('summary'));

    setToolbarFor('overview');
    loadUsers().then(loadEntries);
  });
</script>
</body>
</html>
